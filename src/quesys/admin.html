<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <title>Admin - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="./config.js?v=<?= time() ?>"></script>
  <!-- <script src="./app.js"></script> -->
</head>

<body class="bg-gray-100 min-h-screen p-6">

  <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6">
    <h1 class="text-2xl font-bold mb-2">
      ‚öôÔ∏è Admin Panel
    </h1>
    <p class="text-gray-500 mb-6">
      ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô Dashboard / TV
    </p>

    <div class="flex gap-3 mb-4">
      <button onclick="selectAll(true)" class="px-4 py-2 bg-blue-600 text-white rounded-lg">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      </button>
      <!-- <button class="px-4 py-2 bg-blue-600 text-white rounded-lg" onclick="toggleByLocation('‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏¥‡∏û‡∏±‡∏í‡∏ô‡πå ‡∏ä‡∏±‡πâ‡∏ô2')">
  ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
</button> -->
      <button onclick="selectAll(false)" class="px-4 py-2 bg-gray-300 rounded-lg">
        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      </button>
    </div>

    <div id="location-buttons" class="flex flex-wrap gap-2 mb-4"></div>

    <div id="clinic-list" class="space-y-3 mb-6"></div>

    <button onclick="saveSelection()" class="w-full py-3 bg-green-600 text-white rounded-xl text-lg font-semibold">
      üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
    </button>

    <p id="status" class="text-center text-green-600 mt-4 hidden">
      ‚úî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢
    </p>
  </div>

  <script>

    const params = new URLSearchParams(location.search);
    const HOSPITAL = params.get("hospital");
    const API_URL = window.APP_CONFIG.API_URL + HOSPITAL;
    // const API_URL = window.APP_CONFIG.API_URL;
    const STORAGE_KEY = window.APP_CONFIG.STORAGE_KEY;

    let clinics = [];

    function loadClinics() {



      fetch(API_URL)
        .then(res => res.json())
        .then(data => {
          clinics = data;
          renderList();
          renderLocationButtons();
          renderList();
        });

      // console.log(API_URL)
    }

    function renderLocationButtons() {

      const container = document.getElementById("location-buttons");
      container.innerHTML = "";

      const locations = [...new Set(clinics.map(c => c.lctaddr))];

      locations.forEach(location => {
        const btn = document.createElement("button");
        btn.className =
          "px-4 py-2 bg-blue-600 text-white rounded-lg text-sm";
        btn.innerText = location;

        btn.onclick = () => {
          toggleByLocation(location);

          const isActive = btn.classList.contains("bg-green-600");

          if (isActive) {
            btn.classList.remove("bg-green-600");
            btn.classList.add("bg-blue-600");
          } else {
            btn.classList.remove("bg-blue-600");
            btn.classList.add("bg-green-600");
          }
        };

        container.appendChild(btn);
      });
    }


    function renderList() {
      const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      const container = document.getElementById("clinic-list");
      container.innerHTML = "";

      clinics.forEach(item => {
        const checked = saved.length === 0 || saved.includes(item.orders);

        const row = document.createElement("label");
        row.className =
          "flex items-center justify-between border rounded-lg px-4 py-3 cursor-pointer";

        row.innerHTML = `
  <div>
    <p class="font-semibold">${item.name} <br> (${item.lctaddr})</p>
    <p class="text-sm text-gray-500">
      ‡∏£‡∏≠ ${item.waiting} | ‡πÄ‡∏™‡∏£‡πá‡∏à ${item.done}
    </p>
  </div>
  <input
    type="checkbox"
    value="${item.orders}"
    data-lctaddr="${item.lctaddr}"
    class="w-5 h-5"
    ${checked ? "checked" : ""}
  />
`;


        container.appendChild(row);
      });
    }

    function selectAll(value) {
      document
        .querySelectorAll("#clinic-list input[type=checkbox]")
        .forEach(cb => (cb.checked = value));
    }

    function toggleByLocation(location) {
      const checkboxes = document.querySelectorAll(
        `#clinic-list input[data-lctaddr="${location}"]`
      );

      const allChecked = [...checkboxes].every(cb => cb.checked);

      checkboxes.forEach(cb => cb.checked = !allChecked);
    }


    function saveSelection() {
      const selected = Array.from(
        document.querySelectorAll("#clinic-list input:checked")
      ).map(cb => Number(cb.value));

      localStorage.setItem(STORAGE_KEY, JSON.stringify(selected));

      const status = document.getElementById("status");
      status.classList.remove("hidden");
      window.location.href = `./index.html?hospital=${HOSPITAL}`;
      setTimeout(() => status.classList.add("hidden"), 2000);
    }

    loadClinics();


  </script>

</body>

</html>